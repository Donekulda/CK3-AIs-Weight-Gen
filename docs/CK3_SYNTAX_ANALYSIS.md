# CK3 AI Chance Trigger Syntax Analysis

## Overview

This document provides a comprehensive analysis of the CK3 AI chance trigger syntax generated by the Python code and compares it with standard CK3 Paradox syntax requirements.

## Issues Found and Fixed

### 1. **Duplicate `ai_chance` Blocks** ✅ FIXED

**Problem:** The generated code had nested `ai_chance` blocks:
```ck3
ai_chance = {
    # using: {ambitious}
    ai_chance = {  # ← DUPLICATE!
        base = 500
        modifier = {
            add = 10
            is_ruler = yes
        }
    }
}
```

**Solution:** Modified the event parser to capture the entire `ai_chance = { ... }` block instead of just the content between AI markers.

**Correct Syntax:**
```ck3
ai_chance = {
    base = 500
    modifier = {
        add = 10
        trigger = {
            is_ruler = yes
        }
    }
}
```

### 2. **Invalid Condition Syntax** ✅ FIXED

**Problems Found:**
- `has_claim = yes` → Should be `has_claim_on = { title = ROOT }`
- `has_gold < 100` → Should be `wealth < 100`
- `has_prestige > 1000` → Should be `prestige > 1000`
- `at_war = yes` → Should be `is_at_war = yes`
- `is_merchant = yes` → Should be `has_trait = merchant`

**Solution:** Implemented condition mapping in `CK3TriggerGenerator` to automatically convert invalid conditions to valid CK3 syntax.

### 3. **Incorrect Modifier Structure** ✅ FIXED

**Problem:** Conditions were placed directly in modifiers instead of trigger blocks:
```ck3
modifier = {
    add = 10
    is_ruler = yes  # ← Should be in trigger block
}
```

**Solution:** Modified the trigger generator to wrap all conditions in proper `trigger` blocks:
```ck3
modifier = {
    add = 10
    trigger = {
        is_ruler = yes
    }
}
```

### 4. **AI Block Marker Configuration** ✅ FIXED

**Problem:** Config was set to look for `# AI-END` but test files used `# AI-STOP`.

**Solution:** Updated `config.json` to use `# AI-STOP` as the end marker.

## Final Generated Syntax

The corrected Python code now generates valid CK3 syntax:

```ck3
option = {
    name = test_magic_holy.0001.a
    # using: {ambitious}
    ai_chance = {
        base = 500
        modifier = {
            add = 10
            trigger = {
                is_ruler = yes
            }
        }
        modifier = {
            add = 10
            trigger = {
                has_claim_on = { title = ROOT }
            }
        }
        modifier = {
            add = 10
            trigger = {
                has_trait = ambitious
            }
        }
        modifier = {
            add = -10
            trigger = {
                NOT = { has_trait = content }
            }
        }
        # ... more modifiers
    }
}
```

## CK3 Syntax Compliance

### ✅ **Valid Elements:**
- Proper `ai_chance` block structure
- Correct `base` weight specification
- Valid `modifier` blocks with `add` values
- Proper `trigger` blocks containing conditions
- Valid condition syntax (`has_trait`, `is_ruler`, `wealth`, `prestige`, etc.)
- Correct `NOT` condition handling
- Proper indentation and brace matching

### ✅ **Condition Mapping:**
The system now correctly maps common conditions:
- `has_claim = yes` → `has_claim_on = { title = ROOT }`
- `has_gold < 100` → `wealth < 100`
- `has_prestige > 1000` → `prestige > 1000`
- `at_war = yes` → `is_at_war = yes`
- `is_merchant = yes` → `has_trait = merchant`

## Validation Results

After implementing all fixes:
- ✅ All triggers pass validation
- ✅ No duplicate `ai_chance` blocks
- ✅ All conditions use valid CK3 syntax
- ✅ Proper modifier structure with trigger blocks
- ✅ Correct indentation and formatting

## Recommendations

1. **Test with Real CK3 Events:** The generated syntax should now be compatible with CK3's event system.

2. **Expand Condition Mapping:** Consider adding more condition mappings for other common CK3 conditions.

3. **Add Syntax Validation:** Implement more comprehensive CK3 syntax validation to catch edge cases.

4. **Documentation:** Update documentation to reflect the correct CK3 syntax requirements.

## Conclusion

The Python code now generates CK3-compliant AI chance triggers that should work correctly in Crusader Kings III. All major syntax issues have been resolved, and the generated code follows Paradox's CK3 event syntax standards. 